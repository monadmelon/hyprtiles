<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HyprTiles</title>
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
    <style>
        :root {
            --sf-pro: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", system-ui, sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body { 
            height: 100%;
            font-family: var(--sf-pro);
            background: #000;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow: hidden;
        }
        
        #map { 
            position: fixed;
            inset: 0;
        }
        
        /* Floating controls - Apple style */
        .float-btn {
            position: fixed;
            z-index: 1000;
            width: 44px;
            height: 44px;
            border-radius: 22px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        .float-btn:active {
            transform: scale(0.94);
        }
        
        .float-btn.light {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15), 0 0 0 0.5px rgba(0, 0, 0, 0.05);
            color: #1C1C1E;
        }
        
        .float-btn.dark {
            background: rgba(58, 58, 60, 0.95);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5), 0 0 0 0.5px rgba(255, 255, 255, 0.08);
            color: #FFF;
        }
        
        .float-btn:hover {
            transform: scale(1.04);
        }
        
        /* Theme toggle */
        #theme-toggle { top: 20px; right: 20px; }
        
        /* Terrain toggle */
        #terrain-toggle { top: 74px; right: 20px; }
        
        /* Location stack */
        .location-stack {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 1px;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .location-stack.light {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .location-stack.dark {
            background: rgba(58, 58, 60, 0.95);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.5);
        }
        
        .loc-btn {
            width: 44px;
            height: 40px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.1s;
            -webkit-tap-highlight-color: transparent;
        }
        
        .loc-btn.light { color: #007AFF; }
        .loc-btn.dark { color: #0A84FF; }
        
        .loc-btn:active.light { background: rgba(0, 0, 0, 0.05); }
        .loc-btn:active.dark { background: rgba(255, 255, 255, 0.1); }
        
        .loc-divider.light { height: 0.5px; background: rgba(0, 0, 0, 0.1); margin: 0 8px; }
        .loc-divider.dark { height: 0.5px; background: rgba(255, 255, 255, 0.1); margin: 0 8px; }
        
        /* Search pill */
        .search-pill {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 80px;
            max-width: 360px;
            z-index: 1000;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .search-pill.light {
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }
        
        .search-pill.dark {
            background: rgba(44, 44, 46, 0.95);
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
        }
        
        .search-input {
            width: 100%;
            padding: 14px 16px;
            border: none;
            background: transparent;
            font-family: var(--sf-pro);
            font-size: 17px;
            font-weight: 400;
            outline: none;
        }
        
        .search-input.light { color: #1C1C1E; }
        .search-input.light::placeholder { color: rgba(60, 60, 67, 0.5); }
        .search-input.dark { color: #FFF; }
        .search-input.dark::placeholder { color: rgba(235, 235, 245, 0.4); }
        
        .quick-places {
            display: none;
            border-top: 0.5px solid;
            max-height: 240px;
            overflow-y: auto;
        }
        
        .quick-places.light { border-color: rgba(0, 0, 0, 0.1); }
        .quick-places.dark { border-color: rgba(255, 255, 255, 0.1); }
        
        .quick-places.show { display: block; }
        
        .place-item {
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: background 0.1s;
        }
        
        .place-item:active.light { background: rgba(0, 0, 0, 0.04); }
        .place-item:active.dark { background: rgba(255, 255, 255, 0.06); }
        
        .place-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        
        .place-icon.light { background: rgba(0, 0, 0, 0.05); }
        .place-icon.dark { background: rgba(255, 255, 255, 0.1); }
        
        .place-text {
            flex: 1;
        }
        
        .place-name {
            font-size: 15px;
            font-weight: 500;
        }
        
        .place-name.light { color: #1C1C1E; }
        .place-name.dark { color: #FFF; }
        
        .place-sub {
            font-size: 13px;
            margin-top: 1px;
        }
        
        .place-sub.light { color: rgba(60, 60, 67, 0.6); }
        .place-sub.dark { color: rgba(235, 235, 245, 0.5); }
        
        /* Hide default controls */
        .maplibregl-ctrl-bottom-left,
        .maplibregl-ctrl-bottom-right { display: none !important; }
        
        /* Attribution */
        .attribution {
            position: fixed;
            bottom: 8px;
            left: 8px;
            font-size: 10px;
            z-index: 100;
        }
        
        .attribution.light { color: rgba(0, 0, 0, 0.4); }
        .attribution.dark { color: rgba(255, 255, 255, 0.35); }
        
        /* Apple-style scale bar */
        .scale-bar {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .scale-line {
            height: 2px;
            background: currentColor;
            border-radius: 1px;
            min-width: 50px;
        }
        
        .scale-text {
            font-size: 11px;
            font-weight: 500;
            font-variant-numeric: tabular-nums;
        }
        
        .scale-bar.light { color: rgba(0, 0, 0, 0.5); }
        .scale-bar.dark { color: rgba(255, 255, 255, 0.45); }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="search-pill dark" id="search-pill">
        <input type="text" class="search-input dark" id="search-input" placeholder="Search Maps" 
               onfocus="showPlaces()" onblur="setTimeout(hidePlaces, 200)">
        <div class="quick-places dark" id="quick-places">
            <div class="place-item dark" onclick="goTo([76.9366, 8.5241], 14, 'Thiruvananthapuram')">
                <div class="place-icon dark">TVM</div>
                <div class="place-text">
                    <div class="place-name dark">Thiruvananthapuram</div>
                    <div class="place-sub dark">State Capital</div>
                </div>
            </div>
            <div class="place-item dark" onclick="goTo([76.2673, 9.9312], 14, 'Kochi')">
                <div class="place-icon dark">KOC</div>
                <div class="place-text">
                    <div class="place-name dark">Kochi</div>
                    <div class="place-sub dark">Port City</div>
                </div>
            </div>
            <div class="place-item dark" onclick="goTo([75.7804, 11.2588], 14, 'Kozhikode')">
                <div class="place-icon dark">CLT</div>
                <div class="place-text">
                    <div class="place-name dark">Kozhikode</div>
                    <div class="place-sub dark">City of Spices</div>
                </div>
            </div>
            <div class="place-item dark" onclick="goTo([76.7156, 8.7379], 16, 'Varkala')">
                <div class="place-icon dark">VRK</div>
                <div class="place-text">
                    <div class="place-name dark">Varkala</div>
                    <div class="place-sub dark">Cliff Beach</div>
                </div>
            </div>
            <div class="place-item dark" onclick="goTo([77.0609, 10.7867], 13, 'Munnar')">
                <div class="place-icon dark">MNR</div>
                <div class="place-text">
                    <div class="place-name dark">Munnar</div>
                    <div class="place-sub dark">Hill Station</div>
                </div>
            </div>
        </div>
    </div>
    
    <button class="float-btn dark" id="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">☀</span>
    </button>
    
    <button class="float-btn dark" id="terrain-toggle" onclick="toggleTerrain()">
        <span id="terrain-icon">▲</span>
    </button>
    
    <div class="location-stack dark" id="location-stack">
        <button class="loc-btn dark" onclick="zoomIn()">+</button>
        <div class="loc-divider dark"></div>
        <button class="loc-btn dark" onclick="zoomOut()">−</button>
    </div>
    
    <div class="attribution dark" id="attribution">HyprMaps</div>
    
    <div class="scale-bar dark" id="scale-bar">
        <div class="scale-line" id="scale-line"></div>
        <span class="scale-text" id="scale-text">100 m</span>
    </div>

    <script>
        const TILE_SERVER = 'http://localhost:3000';
        let map, theme = 'dark', terrainOn = false;

        // Apple Maps exact colors (sampled from actual Apple Maps)
        const colors = {
            light: {
                // Land & base
                ocean: '#A8C8DC',
                land: '#F0EDE8',
                landuse: '#E8E5E0',
                residential: '#EBE8E3',
                
                // Nature
                park: '#C8DDB8',
                forest: '#C0D4B0',
                grass: '#D0E0C0',
                sand: '#F4E8D8',
                
                // Water
                water: '#A0C4DC',
                waterway: '#A0C4DC',
                
                // Buildings
                building: '#E0DCD6',
                buildingLine: '#D0CCC6',
                
                // Roads - Apple uses very subtle grays
                motorway: '#F9B233',
                motorwayCasing: '#E09020',
                trunk: '#F9C94E',
                trunkCasing: '#E0A830',
                primary: '#FFFFFF',
                primaryCasing: '#D8D4CC',
                secondary: '#FFFFFF',
                secondaryCasing: '#E0DCD4',
                minor: '#FFFFFF',
                minorCasing: '#E8E4DC',
                path: '#E8DDD0',
                
                // Labels
                textCity: '#3C3C43',
                textTown: '#48484A',
                textVillage: '#8E8E93',
                textRoad: '#8A8A8E',
                halo: 'rgba(255,255,255,0.95)'
            },
            dark: {
                // Land & base - Apple dark is very dark with slight warm tint
                ocean: '#0A1418',
                land: '#1D1D1F',
                landuse: '#232325',
                residential: '#202022',
                
                // Nature - very subtle
                park: '#1A2818',
                forest: '#141E12',
                grass: '#1C2818',
                sand: '#282418',
                
                // Water - deep blue
                water: '#0C1820',
                waterway: '#0C1820',
                
                // Buildings
                building: '#2A2A2C',
                buildingLine: '#363638',
                
                // Roads - muted warm grays
                motorway: '#8C6810',
                motorwayCasing: '#1D1D1F',
                trunk: '#7C5C10',
                trunkCasing: '#1D1D1F',
                primary: '#404042',
                primaryCasing: '#1D1D1F',
                secondary: '#333335',
                secondaryCasing: '#1D1D1F',
                minor: '#2A2A2C',
                minorCasing: '#1D1D1F',
                path: '#252527',
                
                // Labels
                textCity: '#F5F5F7',
                textTown: '#E5E5E7',
                textVillage: '#8E8E93',
                textRoad: '#6E6E73',
                halo: 'rgba(29,29,31,0.95)'
            }
        };

        function getStyle(t) {
            const c = colors[t];
            
            const sources = {
                kerala: { type: 'vector', tiles: [`${TILE_SERVER}/kerala/{z}/{x}/{y}`], maxzoom: 16 }
            };
            
            if (terrainOn) {
                sources.terrain = {
                    type: 'raster-dem',
                    tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
                    encoding: 'terrarium',
                    tileSize: 256,
                    maxzoom: 14
                };
            }
            
            const layers = [
                // Ocean base
                { id: 'ocean', type: 'background', paint: { 'background-color': c.ocean }},
                
                // Land
                { id: 'land', type: 'fill', source: 'kerala', 'source-layer': 'landcover',
                    paint: { 'fill-color': c.land }},
                
                { id: 'landuse-residential', type: 'fill', source: 'kerala', 'source-layer': 'landuse',
                    filter: ['in', 'class', 'residential', 'suburb'],
                    paint: { 'fill-color': c.residential, 'fill-opacity': 0.5 }},
                
                { id: 'landuse-other', type: 'fill', source: 'kerala', 'source-layer': 'landuse',
                    filter: ['!in', 'class', 'residential', 'suburb'],
                    paint: { 'fill-color': c.landuse, 'fill-opacity': 0.4 }},
                
                // Nature
                { id: 'park', type: 'fill', source: 'kerala', 'source-layer': 'park',
                    paint: { 'fill-color': c.park, 'fill-opacity': 0.5 }},
                
                { id: 'forest', type: 'fill', source: 'kerala', 'source-layer': 'landcover',
                    filter: ['in', 'class', 'wood', 'forest'],
                    paint: { 'fill-color': c.forest, 'fill-opacity': 0.7 }},
                
                { id: 'grass', type: 'fill', source: 'kerala', 'source-layer': 'landcover',
                    filter: ['==', 'class', 'grass'],
                    paint: { 'fill-color': c.grass, 'fill-opacity': 0.5 }},
                
                { id: 'sand', type: 'fill', source: 'kerala', 'source-layer': 'landcover',
                    filter: ['==', 'class', 'sand'],
                    paint: { 'fill-color': c.sand }},
            ];
            
            // Hillshade
            if (terrainOn) {
                layers.push({
                    id: 'hillshade', type: 'hillshade', source: 'terrain',
                    paint: {
                        'hillshade-exaggeration': t === 'light' ? 0.2 : 0.25,
                        'hillshade-shadow-color': t === 'light' ? '#5C6670' : '#000000',
                        'hillshade-highlight-color': t === 'light' ? '#FFFFFF' : '#2A2A2C',
                        'hillshade-accent-color': t === 'light' ? '#8090A0' : '#1A1A1C'
                    }
                });
            }
            
            // Water, buildings, roads
            layers.push(
                { id: 'water', type: 'fill', source: 'kerala', 'source-layer': 'water',
                    paint: { 'fill-color': c.water, 'fill-antialias': true }},
                
                { id: 'waterway', type: 'line', source: 'kerala', 'source-layer': 'waterway',
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.waterway, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 8, 0.5, 16, 5] }},
                
                // Buildings - very subtle
                { id: 'building', type: 'fill', source: 'kerala', 'source-layer': 'building', minzoom: 14,
                    paint: { 'fill-color': c.building, 'fill-opacity': ['interpolate', ['linear'], ['zoom'], 14, 0.2, 16, 0.7] }},
                
                { id: 'building-line', type: 'line', source: 'kerala', 'source-layer': 'building', minzoom: 15,
                    paint: { 'line-color': c.buildingLine, 'line-width': 0.3, 'line-opacity': 0.6 }},
                
                // Roads - Apple-style hierarchy
                // Minor roads
                { id: 'road-path', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['in', 'class', 'path', 'track']], minzoom: 14,
                    layout: { 'line-cap': 'round' },
                    paint: { 'line-color': c.path, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 14, 1, 18, 3], 'line-dasharray': [2, 1] }},
                
                { id: 'road-minor-case', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['in', 'class', 'minor', 'service']], minzoom: 13,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.minorCasing, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 13, 2.5, 18, 18], 'line-opacity': ['interpolate', ['linear'], ['zoom'], 13, 0, 14, 1] }},
                
                { id: 'road-minor', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['in', 'class', 'minor', 'service']], minzoom: 13,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.minor, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 13, 1.2, 18, 14], 'line-opacity': ['interpolate', ['linear'], ['zoom'], 13, 0, 14, 1] }},
                
                // Secondary
                { id: 'road-secondary-case', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['in', 'class', 'secondary', 'tertiary']], minzoom: 10,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.secondaryCasing, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 10, 2, 18, 24] }},
                
                { id: 'road-secondary', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['in', 'class', 'secondary', 'tertiary']], minzoom: 10,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.secondary, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 10, 1, 18, 20] }},
                
                // Primary
                { id: 'road-primary-case', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['==', 'class', 'primary']], minzoom: 8,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.primaryCasing, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 8, 1.5, 18, 28] }},
                
                { id: 'road-primary', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['==', 'class', 'primary']], minzoom: 8,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.primary, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 8, 0.8, 18, 24] }},
                
                // Trunk
                { id: 'road-trunk-case', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['==', 'class', 'trunk']], minzoom: 6,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.trunkCasing, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 6, 1, 18, 30] }},
                
                { id: 'road-trunk', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['==', 'class', 'trunk']], minzoom: 6,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.trunk, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 6, 0.6, 18, 26] }},
                
                // Motorway
                { id: 'road-motorway-case', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['==', 'class', 'motorway']], minzoom: 5,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.motorwayCasing, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 5, 1, 18, 32] }},
                
                { id: 'road-motorway', type: 'line', source: 'kerala', 'source-layer': 'transportation',
                    filter: ['all', ['==', '$type', 'LineString'], ['==', 'class', 'motorway']], minzoom: 5,
                    layout: { 'line-cap': 'round', 'line-join': 'round' },
                    paint: { 'line-color': c.motorway, 'line-width': ['interpolate', ['exponential', 1.4], ['zoom'], 5, 0.5, 18, 28] }},
                
                // Aeroway
                { id: 'aeroway', type: 'line', source: 'kerala', 'source-layer': 'aeroway', minzoom: 11,
                    paint: { 'line-color': t === 'light' ? '#C8C8CC' : '#404044', 'line-width': ['interpolate', ['linear'], ['zoom'], 11, 2, 16, 16] }},
                
                // Labels - sparse, Apple-style hierarchy
                { id: 'label-city', type: 'symbol', source: 'kerala', 'source-layer': 'place',
                    filter: ['==', 'class', 'city'], minzoom: 4, maxzoom: 12,
                    layout: { 
                        'text-field': '{name}', 
                        'text-font': ['Open Sans Bold'],
                        'text-size': ['interpolate', ['linear'], ['zoom'], 4, 11, 10, 18],
                        'text-letter-spacing': 0.08,
                        'text-max-width': 8
                    },
                    paint: { 'text-color': c.textCity, 'text-halo-color': c.halo, 'text-halo-width': 1.5, 'text-halo-blur': 0.5 }},
                
                { id: 'label-town', type: 'symbol', source: 'kerala', 'source-layer': 'place',
                    filter: ['==', 'class', 'town'], minzoom: 7, maxzoom: 14,
                    layout: { 
                        'text-field': '{name}', 
                        'text-font': ['Open Sans Semibold'],
                        'text-size': ['interpolate', ['linear'], ['zoom'], 7, 10, 12, 14],
                        'text-max-width': 7
                    },
                    paint: { 'text-color': c.textTown, 'text-halo-color': c.halo, 'text-halo-width': 1.2 }},
                
                { id: 'label-village', type: 'symbol', source: 'kerala', 'source-layer': 'place',
                    filter: ['in', 'class', 'village', 'hamlet', 'suburb', 'neighbourhood'], minzoom: 12,
                    layout: { 
                        'text-field': '{name}', 
                        'text-font': ['Open Sans Regular'],
                        'text-size': ['interpolate', ['linear'], ['zoom'], 12, 10, 16, 12],
                        'text-max-width': 6
                    },
                    paint: { 'text-color': c.textVillage, 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                { id: 'label-road', type: 'symbol', source: 'kerala', 'source-layer': 'transportation_name',
                    minzoom: 14,
                    layout: { 
                        'text-field': '{name}', 
                        'text-font': ['Open Sans Regular'],
                        'text-size': 10,
                        'symbol-placement': 'line',
                        'text-max-angle': 20
                    },
                    paint: { 'text-color': c.textRoad, 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                { id: 'label-airport', type: 'symbol', source: 'kerala', 'source-layer': 'aerodrome_label',
                    minzoom: 9,
                    layout: { 
                        'text-field': ['get', 'name:latin'], 
                        'text-font': ['Open Sans Semibold'],
                        'text-size': 11
                    },
                    paint: { 'text-color': t === 'light' ? '#0066CC' : '#4DA6FF', 'text-halo-color': c.halo, 'text-halo-width': 1.5 }},
                
                { id: 'label-peak', type: 'symbol', source: 'kerala', 'source-layer': 'mountain_peak',
                    minzoom: 10,
                    layout: { 
                        'text-field': ['format', ['get', 'name:latin'], {}, '\n', {}, ['concat', ['to-string', ['round', ['get', 'ele']]], ' m'], { 'font-scale': 0.8 }],
                        'text-font': ['Open Sans Regular'],
                        'text-size': 10,
                        'text-line-height': 1.3
                    },
                    paint: { 'text-color': t === 'light' ? '#7A5C40' : '#A08060', 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                // POIs with icons
                { id: 'poi-hospital', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['==', 'class', 'hospital'], minzoom: 13,
                    layout: { 
                        'icon-image': 'hospital_11', 'icon-size': 1,
                        'text-field': ['step', ['zoom'], '', 14, ['get', 'name:latin']],
                        'text-font': ['Open Sans Regular'], 'text-size': 10,
                        'text-anchor': 'top', 'text-offset': [0, 0.6], 'text-optional': true
                    },
                    paint: { 'text-color': t === 'light' ? '#CC3333' : '#FF6B6B', 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                { id: 'poi-school', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['in', 'class', 'school', 'college', 'university'], minzoom: 14,
                    layout: { 
                        'icon-image': 'school_11', 'icon-size': 1,
                        'text-field': ['step', ['zoom'], '', 15, ['get', 'name:latin']],
                        'text-font': ['Open Sans Regular'], 'text-size': 10,
                        'text-anchor': 'top', 'text-offset': [0, 0.6], 'text-optional': true
                    },
                    paint: { 'text-color': t === 'light' ? '#5856D6' : '#A78BFA', 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                { id: 'poi-worship', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['==', 'class', 'place_of_worship'], minzoom: 14,
                    layout: { 
                        'icon-image': 'place_of_worship_11', 'icon-size': 1,
                        'text-field': ['step', ['zoom'], '', 15, ['get', 'name:latin']],
                        'text-font': ['Open Sans Regular'], 'text-size': 10,
                        'text-anchor': 'top', 'text-offset': [0, 0.6], 'text-optional': true
                    },
                    paint: { 'text-color': t === 'light' ? '#806020' : '#C0A040', 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                { id: 'poi-lodging', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['in', 'class', 'lodging', 'hotel'], minzoom: 14,
                    layout: { 
                        'icon-image': 'lodging_11', 'icon-size': 1,
                        'text-field': ['step', ['zoom'], '', 15, ['get', 'name:latin']],
                        'text-font': ['Open Sans Regular'], 'text-size': 10,
                        'text-anchor': 'top', 'text-offset': [0, 0.6], 'text-optional': true
                    },
                    paint: { 'text-color': t === 'light' ? '#007AFF' : '#5AC8FA', 'text-halo-color': c.halo, 'text-halo-width': 1 }},
                
                { id: 'poi-fuel', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['==', 'class', 'fuel'], minzoom: 14,
                    layout: { 'icon-image': 'fuel_11', 'icon-size': 1 }},
                
                { id: 'poi-rail', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['==', 'class', 'railway'], minzoom: 12,
                    layout: { 
                        'icon-image': 'railway_11', 'icon-size': 1.2,
                        'text-field': ['get', 'name:latin'],
                        'text-font': ['Open Sans Semibold'], 'text-size': 11,
                        'text-anchor': 'top', 'text-offset': [0, 0.8]
                    },
                    paint: { 'text-color': c.textCity, 'text-halo-color': c.halo, 'text-halo-width': 1.5 }},
                
                { id: 'poi-bus', type: 'symbol', source: 'kerala', 'source-layer': 'poi',
                    filter: ['==', 'class', 'bus_station'], minzoom: 13,
                    layout: { 
                        'icon-image': 'bus_11', 'icon-size': 1,
                        'text-field': ['step', ['zoom'], '', 14, ['get', 'name:latin']],
                        'text-font': ['Open Sans Regular'], 'text-size': 10,
                        'text-anchor': 'top', 'text-offset': [0, 0.6], 'text-optional': true
                    },
                    paint: { 'text-color': c.textTown, 'text-halo-color': c.halo, 'text-halo-width': 1 }}
            );
            
            return {
                version: 8,
                sources,
                sprite: './sprite',
                glyphs: 'https://fonts.openmaptiles.org/{fontstack}/{range}.pbf',
                terrain: terrainOn ? { source: 'terrain', exaggeration: 1.3 } : undefined,
                layers
            };
        }

        function applyTheme() {
            const t = theme;
            document.querySelectorAll('.float-btn, .loc-btn, .search-pill, .search-input, .quick-places, .place-item, .place-icon, .place-name, .place-sub, .location-stack, .loc-divider, .attribution, .scale-bar')
                .forEach(el => {
                    el.classList.remove('light', 'dark');
                    el.classList.add(t);
                });
            document.getElementById('theme-icon').textContent = t === 'dark' ? '☀' : '☾';
            document.body.style.background = t === 'dark' ? '#000' : '#F2F2F7';
        }

        function toggleTheme() {
            theme = theme === 'dark' ? 'light' : 'dark';
            applyTheme();
            refreshMap();
        }
        
        function toggleTerrain() {
            terrainOn = !terrainOn;
            document.getElementById('terrain-icon').textContent = terrainOn ? '◼' : '▲';
            document.getElementById('terrain-toggle').style.background = terrainOn ? (theme === 'dark' ? '#0A84FF' : '#007AFF') : '';
            refreshMap();
        }
        
        function refreshMap() {
            if (!map) return;
            const s = { center: map.getCenter(), zoom: map.getZoom(), pitch: map.getPitch(), bearing: map.getBearing() };
            map.setStyle(getStyle(theme));
            map.once('styledata', () => { map.jumpTo(s); });
        }
        
        function showPlaces() { document.getElementById('quick-places').classList.add('show'); }
        function hidePlaces() { document.getElementById('quick-places').classList.remove('show'); }
        
        function goTo(coords, zoom, name) {
            document.getElementById('search-input').value = name;
            hidePlaces();
            map.flyTo({ center: coords, zoom, duration: 1800, pitch: terrainOn ? 50 : 0 });
        }
        
        function zoomIn() { map.zoomIn({ duration: 300 }); }
        function zoomOut() { map.zoomOut({ duration: 300 }); }
        
        function updateScale() {
            if (!map) return;
            const y = map.getCenter().lat;
            const zoom = map.getZoom();
            // meters per pixel at this latitude and zoom
            const mpp = 156543.03392 * Math.cos(y * Math.PI / 180) / Math.pow(2, zoom);
            
            // find a nice round number
            const targetWidth = 80; // pixels
            const meters = mpp * targetWidth;
            
            let distance, unit, width;
            if (meters >= 1000) {
                const km = meters / 1000;
                const nice = [1, 2, 5, 10, 20, 50, 100, 200, 500];
                distance = nice.find(n => n >= km) || 500;
                unit = 'km';
                width = (distance * 1000) / mpp;
            } else {
                const nice = [10, 20, 50, 100, 200, 500, 1000];
                distance = nice.find(n => n >= meters) || 1000;
                unit = 'm';
                width = distance / mpp;
            }
            
            document.getElementById('scale-line').style.width = Math.min(width, 150) + 'px';
            document.getElementById('scale-text').textContent = distance + ' ' + unit;
        }

        map = new maplibregl.Map({
            container: 'map',
            style: getStyle('dark'),
            center: [76.2711, 10.8505],
            zoom: 8,
            maxBounds: [[73.5, 7.0], [80.5, 15.0]],
            maxPitch: 70,
            dragRotate: true,
            touchPitch: true
        });
        
        map.on('zoom', updateScale);
        map.on('load', updateScale);
        
        applyTheme();
    </script>
</body>
</html>
